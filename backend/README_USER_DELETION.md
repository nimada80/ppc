# فرآیند حذف کاربر در سیستم Supabase Auth

این مستند نحوه پیاده‌سازی حذف کاربر در سیستم Supabase Auth را توضیح می‌دهد.

## مروری بر معماری داده

در سیستم ما، اطلاعات کاربر در دو مکان ذخیره می‌شود:
1. **Supabase Auth** - سیستم احراز هویت Supabase که اطلاعات هویتی کاربر را نگهداری می‌کند.
2. **جدول `users`** - جدول اصلی در دیتابیس Supabase که اطلاعات تکمیلی کاربر و روابط آن را ذخیره می‌کند.

## چالش اصلی

چالش اصلی این است که برای حذف کامل یک کاربر، باید هر دو رکورد (در Auth و جدول `users`) حذف شوند. اما این عملیات باید در یک توالی صحیح انجام شود تا از ناسازگاری داده‌ها جلوگیری شود.

## فرآیند بهینه حذف کاربر

1. **مرحله صفر: بررسی وجود کاربر**
   - ابتدا بررسی می‌کنیم آیا کاربر در جدول `users` وجود دارد.
   - اگر کاربر وجود نداشته باشد، پیام خطای مناسبی برمی‌گردانیم.

2. **مرحله اول: حذف ارتباطات**
   - روابط کاربر با سایر موجودیت‌ها (مانند کانال‌ها) را حذف می‌کنیم.
   - این مرحله آماده‌سازی است تا از خطاهای ارجاع خارجی جلوگیری شود.

3. **مرحله دوم: حذف از Auth**
   - کاربر را از سیستم احراز هویت Supabase حذف می‌کنیم.
   - این عملیات را با استفاده از `DELETE /auth/v1/admin/users/{id}` انجام می‌دهیم.
   - بررسی می‌کنیم آیا عملیات حذف موفق بود یا خیر.

4. **مرحله سوم: حذف از جدول users**
   - پس از حذف موفق از Auth، کاربر را از جدول `users` حذف می‌کنیم.
   - این عملیات را با استفاده از `DELETE /rest/v1/users?uid=eq.{id}` انجام می‌دهیم.
   - بررسی می‌کنیم آیا عملیات حذف موفق بود یا خیر.

5. **مرحله چهارم: بررسی نهایی و پاسخ**
   - وضعیت نهایی عملیات را بررسی می‌کنیم.
   - پاسخ مناسب را به کاربر نهایی می‌فرستیم.

## دلایل انجام حذف در این توالی

1. **چرا ابتدا از Auth حذف می‌کنیم؟**
   - زیرا اگر عملیات حذف از Auth با شکست مواجه شود، حذف از جدول `users` باعث ناسازگاری داده‌ها می‌شود.
   - اگر ابتدا از Auth حذف کنیم و موفق نباشیم، می‌توانیم فرآیند را متوقف کنیم.

2. **چرا ارتباطات را ابتدا حذف می‌کنیم؟**
   - حذف ارتباطات از خطاهای مربوط به محدودیت‌های کلید خارجی جلوگیری می‌کند.
   - این مرحله به صورت جداگانه انجام می‌شود تا در صورت خطا، بتوان آن را مدیریت کرد.

## مدیریت خطاها

- **خطای "Database error loading user"**: این خطا معمولاً زمانی رخ می‌دهد که کاربر قبلاً از Auth حذف شده است. در این صورت، فرآیند را ادامه می‌دهیم.
- **خطای "not_found"**: مانند خطای بالا نشان می‌دهد که کاربر در Auth وجود ندارد، پس به حذف از جدول `users` ادامه می‌دهیم.
- **سایر خطاها**: برای سایر خطاها، فرآیند را متوقف کرده و پیام خطای مناسب را برمی‌گردانیم.

## سناریوهای خاص

1. **کاربر فقط در Auth حذف شده است**: در این صورت، فقط کاربر را از جدول `users` حذف می‌کنیم.
2. **کاربر فقط در جدول users حذف شده است**: در این صورت، فقط کاربر را از Auth حذف می‌کنیم.
3. **شکست در حذف ارتباطات**: حذف ارتباطات حیاتی نیست و در صورت شکست، فرآیند حذف کاربر را ادامه می‌دهیم.

## تست

برای تست این فرآیند، دو اسکریپت تست ایجاد شده است:
1. `tests/test_user_delete.py`: تست حذف یک کاربر جدید.
2. `tests/test_existing_user_delete.py`: تست حذف یک کاربر موجود.

## نتیجه

این پیاده‌سازی از الگوی "ابتدا حذف از Auth، سپس حذف از جدول" استفاده می‌کند که سازگاری داده‌ها را تضمین می‌کند و خطاهای احتمالی را به خوبی مدیریت می‌کند. 